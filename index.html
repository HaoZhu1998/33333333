<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Jonathan Nina & Co Capital DCF 模型</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel (让浏览器直接运行 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Recharts 图表库 -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

    <!-- 简单样式，可以按需要再调 -->
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background: #f3f4f6;
        color: #111827;
      }
      .app {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }
      h1 {
        font-size: 26px;
        margin: 0 0 4px;
      }
      .sub-title {
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 20px;
      }
      .scenario-tabs {
        display: flex;
        gap: 8px;
        margin: 16px 0 20px;
        flex-wrap: wrap;
      }
      .scenario-btn {
        padding: 6px 14px;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        font-size: 13px;
        cursor: pointer;
      }
      .scenario-btn.active {
        background: #1d4ed8;
        color: #ffffff;
        border-color: #1d4ed8;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 16px;
      }
      @media (max-width: 900px) {
        .grid-3 {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: #ffffff;
        border-radius: 16px;
        padding: 16px 18px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
      }
      .card-title {
        font-size: 14px;
        font-weight: 600;
        color: #4b5563;
        margin-bottom: 10px;
      }
      .big-price {
        font-size: 32px;
        font-weight: 700;
      }
      .tag {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #ecfdf3;
        color: #16a34a;
        margin-left: 8px;
      }
      .metric-row {
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        color: #4b5563;
      }
      .metric-row span.value {
        font-weight: 600;
        color: #111827;
      }
      .small-muted {
        margin-top: 10px;
        font-size: 11px;
        color: #9ca3af;
      }

      .key-drivers {
        margin-top: 24px;
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 16px;
      }
      @media (max-width: 900px) {
        .key-drivers {
          grid-template-columns: 1fr;
        }
      }
      .slider-group {
        margin-bottom: 16px;
      }
      .slider-label-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-bottom: 4px;
      }
      .slider-label-main {
        font-weight: 500;
      }
      input[type="range"] {
        width: 100%;
      }
      .slider-range-info {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #9ca3af;
        margin-top: 2px;
      }

      .table-wrapper {
        margin-top: 16px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }
      th,
      td {
        border: 1px solid #e5e7eb;
        padding: 6px 8px;
        text-align: right;
      }
      th {
        background: #f9fafb;
        font-weight: 600;
      }
      td.label-cell {
        text-align: left;
        font-weight: 500;
        background: #f9fafb;
      }
      td.highlight {
        background: #1d4ed8;
        color: #ffffff;
        font-weight: 700;
      }
      td.positive {
        color: #16a34a;
      }
      td.negative {
        color: #b91c1c;
      }
      .section-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
      }
      .section-sub {
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 10px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eff6ff;
        color: #1d4ed8;
        margin-bottom: 6px;
      }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo } = React;
      const {
        BarChart,
        Bar,
        XAxis,
        YAxis,
        CartesianGrid,
        Tooltip,
        ResponsiveContainer,
      } = Recharts;

      // 三种情景 + 自定义
      const SCENARIOS = {
        base: {
          label: "基准情景 (Base)",
          wacc: 10,
          terminalGrowth: 1,
          revenueGrowth: 2,
        },
        bull: {
          label: "乐观情景 (Bull)",
          wacc: 8,
          terminalGrowth: 2,
          revenueGrowth: 4,
        },
        bear: {
          label: "悲观情景 (Bear)",
          wacc: 12,
          terminalGrowth: 0.5,
          revenueGrowth: 0.5,
        },
        custom: {
          label: "自定义",
        },
      };

      // DCF 计算函数
      function runDCF(inputs) {
        const years = 5;
        const wacc = inputs.wacc / 100;
        const g = inputs.terminalGrowth / 100;
        const growth = inputs.revenueGrowth / 100;
        const baseFCF = inputs.baseFCF;

        let currentFCF = baseFCF;
        const projectedFCF = [];
        let pvFCF = 0;

        for (let i = 1; i <= years; i++) {
          currentFCF = currentFCF * (1 + growth);
          const discounted = currentFCF / Math.pow(1 + wacc, i);
          projectedFCF.push({ year: "第 " + i + " 年", fcf: currentFCF });
          pvFCF += discounted;
        }

        // 终值（TV）
        const lastYearFCF = projectedFCF[projectedFCF.length - 1].fcf;
        const terminalValue =
          (lastYearFCF * (1 + g)) / (wacc - g > 0.001 ? wacc - g : 0.001);
        const pvTerminalValue =
          terminalValue / Math.pow(1 + wacc, years);

        const enterpriseValue = pvFCF + pvTerminalValue;
        const equityValue = enterpriseValue - inputs.netDebt;
        const impliedPrice = equityValue / inputs.sharesOutstanding;

        const totalPV = pvFCF + pvTerminalValue;
        return {
          projectedFCF,
          impliedPrice,
          enterpriseValue,
          equityValue,
          periodPct: (pvFCF / totalPV) * 100,
          termPct: (pvTerminalValue / totalPV) * 100,
        };
      }

      // 敏感性矩阵
      function buildSensitivity(inputs) {
        const waccSteps = [9, 9.5, 10, 10.5, 11];
        const gSteps = [0.5, 1.0, 1.5];
        const rows = [];

        gSteps.forEach((g) => {
          const row = { g };
          waccSteps.forEach((w) => {
            const res = runDCF({
              ...inputs,
              wacc: w,
              terminalGrowth: g,
            });
            row[w] = res.impliedPrice;
          });
          rows.push(row);
        });

        return { waccSteps, rows };
      }

      function formatMoney(num, decimals = 1) {
        if (!isFinite(num)) return "-";
        if (Math.abs(num) >= 1_000_000_000) {
          return (num / 1_000_000_000).toFixed(decimals) + "B";
        }
        if (Math.abs(num) >= 1_000_000) {
          return (num / 1_000_000).toFixed(decimals) + "M";
        }
        if (Math.abs(num) >= 1_000) {
          return (num / 1_000).toFixed(decimals) + "K";
        }
        return num.toFixed(decimals);
      }

      function App() {
        const [scenarioKey, setScenarioKey] = useState("bear");

        // 这里可以根据公司情况微调参数
        const [inputs, setInputs] = useState({
          wacc: SCENARIOS.bear.wacc,
          terminalGrowth: SCENARIOS.bear.terminalGrowth,
          revenueGrowth: SCENARIOS.bear.revenueGrowth,
          baseFCF: 100, // 起始自由现金流 (假设 100M)
          netDebt: 300, // 净负债
          sharesOutstanding: 70, // 股本 (M 股)
        });

        const dcfResult = useMemo(
          () => runDCF(inputs),
          [inputs]
        );
        const sensitivity = useMemo(
          () => buildSensitivity(inputs),
          [inputs]
        );

        const applyScenario = (key) => {
          if (key === "custom") {
            setScenarioKey("custom");
            return;
          }
          const conf = SCENARIOS[key];
          setScenarioKey(key);
          setInputs((prev) => ({
            ...prev,
            wacc: conf.wacc,
            terminalGrowth: conf.terminalGrowth,
            revenueGrowth: conf.revenueGrowth,
          }));
        };

        const onChangeField = (field, value) => {
          setScenarioKey("custom");
          setInputs((prev) => ({ ...prev, [field]: value }));
        };

        return (
          <div className="app">
            <h1>Jonathan Nina &amp; Co Capital DCF 模型</h1>
            <div className="sub-title">
              现金流折现分析与敏感性仪表盘 (示例 Demo，可面试时展示交互效果)
            </div>

            {/* 情景选择 */}
            <div className="scenario-tabs">
              {Object.entries(SCENARIOS).map(([key, conf]) => (
                <button
                  key={key}
                  className={
                    "scenario-btn" +
                    (scenarioKey === key ? " active" : "")
                  }
                  onClick={() => applyScenario(key)}
                >
                  {conf.label}
                </button>
              ))}
            </div>

            {/* 上方三张卡片 */}
            <div className="grid-3">
              {/* 隐含股价 */}
              <div className="card">
                <div className="card-title">隐含股价 (IMPLIED PRICE)</div>
                <div className="big-price">
                  ${dcfResult.impliedPrice.toFixed(2)}
                  <span className="tag">持有评级 · Demo</span>
                </div>
                <div className="metric-row">
                  <span>企业价值 (EV)</span>
                  <span className="value">
                    ${formatMoney(dcfResult.enterpriseValue, 1)}
                  </span>
                </div>
                <div className="metric-row">
                  <span>股权价值 (Equity Value)</span>
                  <span className="value">
                    ${formatMoney(dcfResult.equityValue, 1)}
                  </span>
                </div>
                <div className="small-muted">
                  * 所有数值仅为练习使用的假设数据，用于展示 DCF
                  建模与可视化能力。
                </div>
              </div>

              {/* 自由现金流预测 */}
              <div className="card">
                <div className="card-title">自由现金流预测 (无杠杆 FCF)</div>
                <ResponsiveContainer width="100%" height={170}>
                  <BarChart data={dcfResult.projectedFCF}>
                    <CartesianGrid
                      strokeDasharray="3 3"
                      vertical={false}
                    />
                    <XAxis
                      dataKey="year"
                      tickLine={false}
                      axisLine={false}
                    />
                    <YAxis
                      tickLine={false}
                      axisLine={false}
                      tickFormatter={(v) => v.toFixed(0)}
                    />
                    <Tooltip
                      formatter={(v) => v.toFixed(1)}
                      labelFormatter={(l) => l}
                    />
                    <Bar dataKey="fcf" radius={[6, 6, 0, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              </div>

              {/* 企业价值构成 */}
              <div className="card">
                <div className="card-title">
                  企业价值构成 (基于现值分解)
                </div>
                <div className="metric-row">
                  <span>预测期现值 (5 年)</span>
                  <span className="value">
                    {dcfResult.periodPct.toFixed(1)}%
                  </span>
                </div>
                <div className="metric-row">
                  <span>终值现值 (Terminal Value)</span>
                  <span className="value">
                    {dcfResult.termPct.toFixed(1)}%
                  </span>
                </div>
                <div className="small-muted">
                  终值在大多数 DCF 模型中通常占企业价值的 60%–80%。此 Demo
                  用来向面试官解释：WACC 与 g 对估值的影响非常敏感。
                </div>
              </div>
            </div>

            {/* 下方：Drivers + 敏感性 */}
            <div className="key-drivers">
              {/* 左侧：关键假设 */}
              <div className="card">
                <div className="badge">核心假设 (Key Drivers)</div>
                <div className="section-sub">
                  面试时可以现场拖动滑块，讲解 WACC、永续增长率和收入
                  CAGR 如何驱动 DCF 输出。
                </div>

                <div className="slider-group">
                  <div className="slider-label-row">
                    <span className="slider-label-main">
                      WACC (加权平均资本成本)
                    </span>
                    <span>{inputs.wacc.toFixed(1)}%</span>
                  </div>
                  <input
                    type="range"
                    min="5"
                    max="15"
                    step="0.5"
                    value={inputs.wacc}
                    onChange={(e) =>
                      onChangeField("wacc", Number(e.target.value))
                    }
                  />
                  <div className="slider-range-info">
                    <span>5%</span>
                    <span>15%</span>
                  </div>
                </div>

                <div className="slider-group">
                  <div className="slider-label-row">
                    <span className="slider-label-main">
                      永续增长率 (Terminal g)
                    </span>
                    <span>{inputs.terminalGrowth.toFixed(1)}%</span>
                  </div>
                  <input
                    type="range"
                    min="0.0"
                    max="3.0"
                    step="0.1"
                    value={inputs.terminalGrowth}
                    onChange={(e) =>
                      onChangeField(
                        "terminalGrowth",
                        Number(e.target.value)
                      )
                    }
                  />
                  <div className="slider-range-info">
                    <span>0%</span>
                    <span>3%</span>
                  </div>
                </div>

                <div className="slider-group">
                  <div className="slider-label-row">
                    <span className="slider-label-main">
                      营收复合年增长率 (未来 5 年)
                    </span>
                    <span>{inputs.revenueGrowth.toFixed(1)}%</span>
                  </div>
                  <input
                    type="range"
                    min="0"
                    max="5"
                    step="0.5"
                    value={inputs.revenueGrowth}
                    onChange={(e) =>
                      onChangeField(
                        "revenueGrowth",
                        Number(e.target.value)
                      )
                    }
                  />
                  <div className="slider-range-info">
                    <span>0%</span>
                    <span>5%</span>
                  </div>
                </div>

                <div className="small-muted">
                  说明思路示例：
                  “我用一个完全自建的交互式 DCF 仪表盘来分析交易，内部把
                  WACC、g 和增长率作为核心驱动因子，通过滑块和敏感性表瞬间看到估值变化，方便和
                  MD / VP 讨论不同情景假设。”
                </div>
              </div>

              {/* 右侧：敏感性表 */}
              <div className="card">
                <div className="section-title">敏感性分析：股价</div>
                <div className="section-sub">
                  行：终值增长率 (g) · 列：WACC，便于快速看到“高增长 + 低折现率”对估值的放大效应。
                </div>

                <div className="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th className="label-cell">g / WACC</th>
                        {sensitivity.waccSteps.map((w) => (
                          <th key={w}>{w.toFixed(1)}%</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {sensitivity.rows.map((row) => (
                        <tr key={row.g}>
                          <td className="label-cell">
                            {row.g.toFixed(1)}%
                          </td>
                          {sensitivity.waccSteps.map((w) => {
                            const val = row[w];
                            const diff =
                              ((val - dcfResult.impliedPrice) /
                                dcfResult.impliedPrice) *
                              100;
                            const isCenter =
                              Math.abs(w - inputs.wacc) < 0.001 &&
                              Math.abs(row.g - inputs.terminalGrowth) <
                                0.001;
                            const cls =
                              " " +
                              (isCenter
                                ? "highlight"
                                : diff >= 0
                                ? "positive"
                                : "negative");
                            return (
                              <td key={w} className={cls.trim()}>
                                ${val.toFixed(1)}
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <div className="small-muted">
                  面试时可以指着中心蓝色格子说：
                  “当前假设下的隐含价格在这里；如果 WACC 上升 100bps
                  或 g 下调 50bps，估值会如何移动”，展示你对估值敏感性的理解。
                </div>
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
